<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MQTT Dashboard (HTML5)</title>

  <!-- Estilos simples y responsivos -->
  <style>
    :root{
      --bg:#f5f7fb;
      --card:#fff;
      --accent:#2b7cff;
      --muted:#6b7280;
      --danger:#ef4444;
    }
    html,body{height:100%;margin:0;font-family:Inter, UI-Sans-Serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;}
    body{background:var(--bg);padding:18px;box-sizing:border-box;color:#111;}
    .container{max-width:1100px;margin:0 auto;}
    header{display:flex;align-items:center;justify-content:space-between;gap:16px;margin-bottom:14px;}
    h1{font-size:20px;margin:0}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
    .card{background:var(--card);padding:12px;border-radius:10px;box-shadow:0 6px 18px rgba(16,24,40,0.06);}
    .span-4{grid-column:span 4}
    .span-8{grid-column:span 8}
    .span-12{grid-column:span 12}
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    input[type=text], input[type=number], select, textarea{
      width:100%;padding:8px;border-radius:6px;border:1px solid #e6e9ef;font-size:14px;box-sizing:border-box;
    }
    button{background:var(--accent);color:#fff;border:0;padding:8px 12px;border-radius:8px;cursor:pointer;}
    button.secondary{background:#eef2ff;color:var(--accent);border:1px solid rgba(43,124,255,0.12)}
    .status{display:inline-flex;align-items:center;gap:8px;font-weight:600}
    .status .dot{width:10px;height:10px;border-radius:50%;}
    .dot.green{background:#10b981}
    .dot.red{background:var(--danger)}
    .msgs{max-height:300px;overflow:auto;padding:6px;border-radius:6px;border:1px solid #eef2f6;background:#fcfeff}
    .msg{padding:6px;border-bottom:1px solid #f1f5f9;font-size:13px}
    .controls{display:flex;gap:8px;align-items:end}
    .small{font-size:13px;color:var(--muted)}
    @media (max-width:880px){
      .span-4,.span-8{grid-column:span 12}
    }
  </style>

  <!-- Librerías -->
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>
  <div class="container">
    <header>
      <h1>MQTT Dashboard — HTML5</h1>
      <div>
        <span class="status" id="connStatus"><span class="dot red" id="connDot"></span><span id="connText">Desconectado</span></span>
      </div>
    </header>

    <div class="grid">
      <!-- Panel de conexión -->
      <div class="card span-4">
        <label>Broker (WebSocket) <span class="small">e.g. wss://28955e326d1f412db03f01769c814d7d.s1.eu.hivemq.cloud:8884</span></label>
        <input id="brokerUrl" type="text" value="wss://test.mosquitto.org:8081" />
        <label>Client ID</label>
        <input id="clientId" type="text" value="web-dashboard-<?= Math.floor(Math.random()*10000) ?>" />
        <label>Tópico (subscribe)</label>
        <input id="topic" type="text" value="demo/test" />
        <div style="display:flex;gap:8px;margin-top:10px;">
          <button id="connectBtn">Conectar</button>
          <button id="disconnectBtn" class="secondary">Desconectar</button>
        </div>

        <hr style="margin:10px 0">

        <label>Últimos mensajes</label>
        <div class="msgs" id="messagesBox"></div>
        <div style="margin-top:8px">
          <label class="small">Máx mensajes a mostrar</label>
          <input id="maxMessages" type="number" value="100" min="10" />
        </div>
      </div>

      <!-- Gráficos -->
      <div class="card span-8">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
          <div>
            <label>Gráfico de valores (series temporales)</label>
            <div class="small">Se agregan valores numéricos si el payload es JSON con campo numeric: {"value": 23.4} o si el mensaje es un número puro.</div>
          </div>
          <div style="display:flex;gap:8px;align-items:center">
            <label class="small">Intervalo (ms)</label>
            <input id="chartInterval" type="number" value="1000" style="width:90px"/>
          </div>
        </div>
        <canvas id="lineChart" height="200"></canvas>
      </div>

      <!-- Gauge y Publish -->
      <div class="card span-4">
        <label>Gauge (último valor)</label>
        <canvas id="gaugeChart" height="180"></canvas>
        <div style="margin-top:8px">
          <label>Min</label>
          <input id="gMin" type="number" value="0" />
          <label>Max</label>
          <input id="gMax" type="number" value="100" />
        </div>
      </div>

      <div class="card span-8">
        <label>Publicar mensaje</label>
        <label>Tópico</label>
        <input id="pubTopic" type="text" value="demo/test" />
        <label>Payload (texto / JSON)</label>
        <textarea id="pubPayload" rows="3">{ "value": 42 }</textarea>
        <div style="display:flex;gap:8px;margin-top:8px;">
          <button id="publishBtn">Publicar</button>
          <button id="clearBtn" class="secondary">Limpiar mensajes</button>
        </div>
      </div>

      <!-- Tabla o logs -->
      <div class="card span-12">
        <label>Registro completo (últimos recibidos)</label>
        <div id="logTable" style="max-height:220px;overflow:auto;margin-top:8px;border-radius:6px;border:1px solid #eef3fb;background:#fff;padding:6px"></div>
      </div>
    </div><!-- grid -->
  </div><!-- container -->

<script>
/* -------------------------
   Variables y elementos DOM
   ------------------------- */
const connectBtn = document.getElementById('connectBtn');
const disconnectBtn = document.getElementById('disconnectBtn');
const brokerUrlInput = document.getElementById('brokerUrl');
const clientIdInput = document.getElementById('clientId');
const topicInput = document.getElementById('topic');
const connDot = document.getElementById('connDot');
const connText = document.getElementById('connText');
const messagesBox = document.getElementById('messagesBox');
const maxMessagesInput = document.getElementById('maxMessages');
const logTable = document.getElementById('logTable');
const publishBtn = document.getElementById('publishBtn');
const pubTopic = document.getElementById('pubTopic');
const pubPayload = document.getElementById('pubPayload');
const clearBtn = document.getElementById('clearBtn');
const chartIntervalInput = document.getElementById('chartInterval');
const gMinInput = document.getElementById('gMin');
const gMaxInput = document.getElementById('gMax');

let client = null;
let subscribed = false;
let messageLog = []; // almacena objetos {topic,payload,ts}
const MAX_SERIES_POINTS = 60;

/* -------------------------
   Chart.js Inicialización
   ------------------------- */
// Line chart (series temporales)
const lineCtx = document.getElementById('lineChart').getContext('2d');
const lineChart = new Chart(lineCtx, {
  type: 'line',
  data: { labels: [], datasets: [{ label: 'valor', data: [], tension:0.25, pointRadius:2 }] },
  options: {
    responsive:true,
    maintainAspectRatio:false,
    scales: {
      x: { display:true, title:{display:false} },
      y: { display:true, title:{display:{text:'Valor'}} }
    },
    plugins: { legend:{display:false} }
  }
});

// Gauge (usamos doughnut)
const gaugeCtx = document.getElementById('gaugeChart').getContext('2d');
const gaugeChart = new Chart(gaugeCtx, {
  type: 'doughnut',
  data: { labels: ['value','rest'], datasets: [{ data: [0,100], borderWidth:0 }] },
  options: {
    rotation: -135 * Math.PI/180,
    circumference: 270 * Math.PI/180,
    cutout: '70%',
    plugins:{
      legend:{display:false},
      tooltip:{enabled:false},
    }
  }
});

/* -------------------------
   Utilidades
   ------------------------- */
function setStatus(connected){
  if(connected){
    connDot.classList.remove('red'); connDot.classList.add('green');
    connText.textContent = 'Conectado';
  } else {
    connDot.classList.remove('green'); connDot.classList.add('red');
    connText.textContent = 'Desconectado';
  }
}

function addMessageToUI(topic, payload) {
  const max = parseInt(maxMessagesInput.value) || 200;
  const div = document.createElement('div');
  div.className = 'msg';
  const time = new Date().toLocaleTimeString();
  // mostrar payload truncado si largo
  const ptext = payload.length>300 ? payload.slice(0,300)+'…' : payload;
  div.innerHTML = `<strong>[${time}]</strong> <span style="color:#0f172a">${topic}</span><div style="margin-top:6px;color:#111">${escapeHtml(ptext)}</div>`;
  messagesBox.prepend(div);
  // limitar cantidad
  while(messagesBox.children.length > max) messagesBox.removeChild(messagesBox.lastChild);
}

function addLogEntry(topic, payload){
  const ts = new Date().toLocaleString();
  messageLog.unshift({topic,payload,ts});
  // mantener hasta 500 entradas
  if(messageLog.length>500) messageLog.pop();
  renderLog();
}

function renderLog(){
  logTable.innerHTML = messageLog.map(m => 
    `<div style="padding:8px;border-bottom:1px solid #f1f5f9">
      <div style="font-size:13px;color:${'#111'}"><strong>${escapeHtml(m.topic)}</strong> <span style="color:#6b7280">· ${escapeHtml(m.ts)}</span></div>
      <div style="font-family:monospace;margin-top:6px;font-size:13px;color:#0b1220">${escapeHtml(m.payload)}</div>
    </div>`).join('');
}

function escapeHtml(s){
  return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');
}

/* -------------------------
   MQTT: conectar / eventos
   ------------------------- */
connectBtn.addEventListener('click', () => {
  const broker = brokerUrlInput.value.trim();
  if(!broker){ alert('Ingresá la URL del broker WebSocket (wss://...)'); return; }
  // conectamos
  const clientId = clientIdInput.value.trim() || 'web-dashboard-' + Math.floor(Math.random()*10000);
  try {
    client = mqtt.connect(broker, {
      clientId,
      connectTimeout: 5000,
      keepalive: 30,
      clean: true,
      reconnectPeriod: 2000
    });
  } catch(e){
    alert('Error al crear conexión: ' + e.message);
    return;
  }

  client.on('connect', () => {
    setStatus(true);
    const topic = topicInput.value.trim();
    if(topic){
      client.subscribe(topic, {qos:0}, (err) => {
        if(err) {
          console.error('Subscribe error', err);
          alert('Error al suscribirse: '+err.message);
        } else {
          subscribed = true;
          addMessageToUI('system', `Suscrito a ${topic}`);
        }
      });
    }
  });

  client.on('reconnect', () => { connText.textContent = 'Reconectando...'; connDot.classList.add('red'); });
  client.on('error', (err) => { console.error('MQTT Error', err); addMessageToUI('system','Error: '+(err && err.message)); });
  client.on('close', () => { setStatus(false); subscribed=false; });

  client.on('message', (topic, messageBuf) => {
    const payload = messageBuf.toString();
    addMessageToUI(topic, payload);
    addLogEntry(topic,payload);
    // tratar de obtener valor numérico/JSON
    processIncomingValue(topic,payload);
  });
});

disconnectBtn.addEventListener('click', () => {
  if(client){
    try{ client.end(true); } catch(e){}
    client = null;
    setStatus(false);
    addMessageToUI('system','Desconectado por usuario');
  }
});

/* -------------------------
   Procesar payloads y actualizar gráficas
   ------------------------- */
function processIncomingValue(topic, payload){
  // si payload es JSON y tiene campo "value" o "valor", lo tomamos; si es solo número, lo tomamos.
  let value = null;
  try{
    const t = payload.trim();
    if(/^[-+]?\d*\.?\d+$/.test(t)){
      value = parseFloat(t);
    } else {
      const obj = JSON.parse(t);
      if(typeof obj === 'number') value = obj;
      else if(obj && typeof obj.value === 'number') value = obj.value;
      else if(obj && typeof obj.valor === 'number') value = obj.valor;
      else {
        // buscar primer campo numérico
        for(const k in obj){
          if(typeof obj[k] === 'number'){ value = obj[k]; break; }
        }
      }
    }
  } catch(e){
    // no JSON, no número puro => ignorar para chart
  }

  if(typeof value === 'number'){
    pushValueToChart(value);
    updateGauge(value);
  }
}

/* Chart data push */
function pushValueToChart(value){
  const labels = lineChart.data.labels;
  const data = lineChart.data.datasets[0].data;
  const now = new Date();
  labels.push(now.toLocaleTimeString());
  data.push(Number(value));
  if(labels.length > MAX_SERIES_POINTS){
    labels.shift();
    data.shift();
  }
  lineChart.update('none');
}

/* Gauge update */
function updateGauge(value){
  const min = Number(gMinInput.value) || 0;
  const max = Number(gMaxInput.value) || 100;
  const clamped = Math.max(min, Math.min(max, value));
  const percent = ((clamped - min) / Math.max(1, (max - min))) * 100;
  gaugeChart.data.datasets[0].data = [percent, 100 - percent];
  gaugeChart.update('none');
}

/* -------------------------
   Publicar mensajes
   ------------------------- */
publishBtn.addEventListener('click', () => {
  if(!client || !client.connected){ alert('No estás conectado al broker'); return; }
  const t = pubTopic.value.trim();
  const payload = pubPayload.value;
  try{
    client.publish(t, payload, {qos:0, retain:false}, (err) => {
      if(err) addMessageToUI('system','Error al enviar: '+err.message);
      else addMessageToUI('pub', `Publicado a ${t}: ${payload}`);
    });
  } catch(e){
    alert('Error al publicar: ' + e.message);
  }
});

/* -------------------------
   Otros controles
   ------------------------- */
clearBtn.addEventListener('click', () => {
  messagesBox.innerHTML = '';
  messageLog = [];
  renderLog();
});

/* Inicializar estado visual */
setStatus(false);

/* -------------------------
   Notas:
   - Cambiá brokerUrl por tu broker que soporte WebSocket (wss://).
   - Si usás autenticación, extendé mqtt.connect(broker, {username:'user',password:'pass',...})
   - Para múltiples tópicos: separalos con coma y suscribite manualmente.
   - El chart sólo añadirá puntos si detecta un número en el payload.
   ------------------------- */
</script>
</body>
</html>

